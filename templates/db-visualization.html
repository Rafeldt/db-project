<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DB Visualization</title>

  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    header { padding: 14px 16px; border-bottom: 1px solid #e9e9e9; display:flex; gap:12px; align-items:baseline; }
    header h1 { font-size: 16px; margin: 0; }
    header a { font-size: 14px; text-decoration: none; }
    #wrap { padding: 12px; }
    .tooltip {
      position: fixed; pointer-events: none;
      padding: 8px 10px; font-size: 12px;
      border: 1px solid #ddd; border-radius: 10px;
      background: rgba(255,255,255,0.98);
      box-shadow: 0 10px 30px rgba(0,0,0,0.10);
      display: none; max-width: 420px;
    }
    svg { width: 100%; height: auto; }
  </style>
</head>

<body>
  <header>
    <h1>Users â†’ Todos (Bundled Hierarchy)</h1>
    <span style="flex:1"></span>
    <a href="/">Home</a>
    <a href="/db-visualization">Refresh</a>
  </header>

  <div id="wrap">
    <div style="font-size:13px; opacity:.75; margin: 6px 0 12px;">
      Hover a label to highlight its connections.
    </div>
    <div id="chart"></div>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <script>
    const data = {{ graph_data | tojson }};

    function hierarchy(data, delimiter = ".") {
      const map = new Map();
      for (const d of data) {
        const name = d.name;
        if (!map.has(name)) map.set(name, d);

        const i = name.lastIndexOf(delimiter);
        if (i >= 0) {
          const parent = name.slice(0, i);
          if (!map.has(parent)) map.set(parent, { name: parent });
        }
      }

      const stratify = d3.stratify()
        .id(d => d.name)
        .parentId(d => {
          const i = d.name.lastIndexOf(delimiter);
          return i >= 0 ? d.name.slice(0, i) : null;
        });

      return stratify(Array.from(map.values()));
    }

    function bilink(root) {
      const leaves = root.leaves();
      const map = new Map(leaves.map(d => [d.data.name, d]));

      for (const d of leaves) {
        d.incoming = [];
        const imports = d.data.imports || [];
        d.outgoing = imports
          .map(i => map.get(i))
          .filter(Boolean)
          .map(target => [d, target]);
      }
      for (const d of leaves) for (const l of d.outgoing) l[1].incoming.push(l);
      return root;
    }

    const width = 980;
    const radius = width / 2;

    const cluster = d3.cluster().size([2 * Math.PI, radius - 130]);
    const root = bilink(cluster(hierarchy(data)));

    const line = d3.lineRadial()
      .curve(d3.curveBundle.beta(0.85))
      .radius(d => d.y)
      .angle(d => d.x);

    const tooltip = document.getElementById("tooltip");

    const svg = d3.create("svg")
      .attr("viewBox", [-radius, -radius, width, width]);

    const link = svg.append("g")
      .attr("fill", "none")
      .attr("stroke", "#bbb")
      .attr("stroke-opacity", 0.55)
      .attr("stroke-width", 1.15)
      .selectAll("path")
      .data(root.leaves().flatMap(d => d.outgoing))
      .join("path")
      .attr("d", ([i, o]) => line(i.path(o)));

    const node = svg.append("g")
      .selectAll("g")
      .data(root.leaves())
      .join("g")
      .attr("transform", d => `rotate(${d.x * 180 / Math.PI - 90}) translate(${d.y},0)`);

    node.append("text")
      .attr("dy", "0.31em")
      .attr("x", d => d.x < Math.PI ? 6 : -6)
      .attr("text-anchor", d => d.x < Math.PI ? "start" : "end")
      .attr("transform", d => d.x >= Math.PI ? "rotate(180)" : null)
      .attr("font-size", 12)
      .attr("fill", d => d.data.type === "user" ? "#0b7285" : "#5f3dc4")
      .text(d => d.data.label ?? d.data.name.split(".").pop())
      .on("mouseenter", (event, d) => {
        link
          .attr("stroke-opacity", l => (l[0] === d || l[1] === d) ? 1 : 0.06)
          .attr("stroke-width", l => (l[0] === d || l[1] === d) ? 2.2 : 1.1);

        tooltip.style.display = "block";
        tooltip.textContent = (d.data.type === "user")
          ? `User: ${d.data.label}`
          : `Todo: ${d.data.label}`;
      })
      .on("mousemove", (event) => {
        tooltip.style.left = (event.clientX + 12) + "px";
        tooltip.style.top  = (event.clientY + 12) + "px";
      })
      .on("mouseleave", () => {
        link
          .attr("stroke-opacity", 0.55)
          .attr("stroke-width", 1.15);

        tooltip.style.display = "none";
      });

    document.getElementById("chart").appendChild(svg.node());
  </script>
</body>
</html>
